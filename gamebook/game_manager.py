from gamebook.scene import Scene
from gamebook.exceptions import *
import gamebook.important_strings


class GameManager(object):
    def __init__(self, scenes_import, output_instance, input_instance):
        """
            takes care of presenting the scenes to the user and moving
            from one scene to next fluently

            scenes_import: a list of all the sceness
        """
        self.scenes_import = scenes_import
        self.output_instance = output_instance
        self.input_instance = input_instance

    def start(self, current_scene):
        """
            current_scene: the current scene the player is in at the moment.
            insert the first scene for your game.
        """
        self.current_scene = current_scene
        while True:
            try:
                next_scene_name = self.run_scene()
                self.current_scene = self.get_next_scene(next_scene_name)

            except ReachedTheEndException:
                self.output_instance.exit(gamebook.important_strings.
                                          end_message)
                break

            except ExitRequested:
                self.output_instance.exit(gamebook.important_strings.
                                          exit_message)
                break

    def get_next_scene(self, scene_name):
        for scene in self.scenes_import:
            if scene.get_name() == scene_name:
                return scene

    def run_scene(self):
        """evaluates the current scene and returns
           the following one by it's name"""

        self.output_instance.output(self.current_scene.show_desc())

        if len(self.current_scene.options) == 0:
            # if the current scene has no options, the game ends
            raise ReachedTheEndException

        user_input = self.input_instance.\
            ask_for_user_inputs(self.current_scene.options)

        if user_input == gamebook.important_strings.exit_user_input:
            # the user wants to quit the game
            raise ExitRequested

        while True:
            try:
                next_scene = self.current_scene.next_scene_draw(user_input)
                if isinstance(next_scene, str):
                    return next_scene
                return next_scene.get_scene_name()

            except OptionNotFoundError:
                self.output_instance.output(gamebook.important_strings.
                                            invalid_user_input_message)

                user_input = self.input_instance.input(gamebook.
                                                       important_strings.
                                                       input_prompt)
